<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer">
  <title>–°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º VK Bridge —Å—Ä–∞–∑—É –≤ head -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    .story-box {
      background: rgba(0,0,0,0.2);
      border-radius: 18px;
      padding: 20px;
      margin: 20px 0;
      font-size: 18px;
      line-height: 1.5;
      white-space: pre-wrap;
      border: 1px dashed rgba(255,255,255,0.3);
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn-free {
      background: linear-gradient(45deg, #ff9a9e, #fad0c4);
      color: #8b4513;
    }
    .btn-premium {
      background: linear-gradient(45deg, #a1c4fd, #c2e9fb);
      color: #2c3e50;
      position: relative;
      overflow: hidden;
    }
    .btn-premium::after {
      content: "üíé";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
    }
    .btn-share {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
    }
    .btn-share:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 75, 43, 0.6);
    }
    .result {
      background: rgba(0,0,0,0.25);
      border-radius: 20px;
      padding: 24px;
      margin: 24px 0;
      font-size: 18px;
      line-height: 1.6;
      border: 2px solid #ffcc00;
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .rarity {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.2);
    }
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
    }
    .footer {
      margin-top: 20px;
      font-size: 14px;
      opacity: 0.8;
    }
    .loading {
      font-size: 20px;
      margin: 40px 0;
      animation: pulse 1.5s infinite;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      font-size: 14px;
    }
    .image-preview {
      max-width: 100%;
      border-radius: 12px;
      margin: 15px 0;
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .share-options {
      background: rgba(0,0,0,0.3);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
    }
    .share-options h3 {
      color: #ffd700;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .share-method {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      text-align: left;
    }
    .share-method h4 {
      color: #a1c4fd;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• –°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</h1>
    <div id="game">
      <div class="loading">‚ú® –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="status" class="status"></div>
    <div class="footer">–°–æ–∑–¥–∞–Ω–æ —Å –∞–±—Å—É—Ä–¥–æ–º –∏ –ª—é–±–æ–≤—å—é ‚ù§Ô∏è</div>
  </div>

  <div class="confetti" id="confetti"></div>
  <div id="modal-container"></div>

  <script>
    // –ò–°–¢–û–†–ò–ò
    const STORIES = {
      "1": {
        "text": "üî• –¢—ã –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Ç–µ–ª–µ –ò–ò, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –º–µ–º–∞–º–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π...\n\n–ß—Ç–æ –∑–∞–ø—É—Å—Ç–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üí• –¢–´ –°–¢–ê–õ: –ú–ï–ú-–ë–û–ì\n\n–¢–≤–æ–π –º–µ–º ¬´–ü–ª–∞—á—å –∫–∞–∫ –ë–∞–π–¥–µ–Ω –Ω–∞ –±–∞–ª–∞–ª–∞–π–∫–µ¬ª\n–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ 2.1 –º–ª—Ä–¥ —á–µ–ª–æ–≤–µ–∫.\n–¢—ã –∑–∞–ø—Ä–µ—â—ë–Ω –≤ 3 –≥–∞–ª–∞–∫—Ç–∏–∫–∞—Ö.\n\nüèÜ –£—Ä–æ–≤–µ–Ω—å —Ö–∞–æ—Å–∞: 999/100",
            "premium": false
          },
          "B": {
            "outcome": "üïäÔ∏è –¢–´ –°–¢–ê–õ: –ú–ò–†–û–¢–í–û–†–ï–¶ –ú–ï–ú–û–í\n\n–¢—ã —É–±–µ–¥–∏–ª –≤—Å–µ—Ö, —á—Ç–æ ¬´–∫–æ—Ç —Å –æ–≥—É—Ä—Ü–æ–º¬ª ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ.\n–ú–∏—Ä –æ–±—ä–µ–¥–∏–Ω–∏–ª—Å—è –≤ —Ö–æ—Ö–æ—Ç–µ.\n\n‚òÆÔ∏è –£—Ä–æ–≤–µ–Ω—å –º–∏—Ä–∞: 100/100",
            "premium": false
          }
        }
      },
      "2": {
        "text": "üõ∏ –¢—ã –Ω–∞—à—ë–ª –ù–õ–û –≤ –≥–∞—Ä–∞–∂–µ. –ó–∞–≤–æ–¥–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üöÄ –¢–´ –°–¢–ê–õ: –ú–ê–†–°–ò–ê–ù–°–ö–ò–ú –ü–ò–¶–¶–ï–†–û–ú\n\n–û—Ç–∫—Ä—ã–ª –ø–∏—Ü—Ü–µ—Ä–∏—é –Ω–∞ –ö—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ.\n–ú–∞—Ä—Å–∏–∞–Ω–µ —Ç–µ–ø–µ—Ä—å –µ–¥—è—Ç —Ç–æ–ª—å–∫–æ ¬´–ü–µ–ø–ø–µ—Ä–æ–Ω–∏-2077¬ª.\n\nüçï –£—Ä–æ–≤–µ–Ω—å –≤–∫—É—Å–∞: 100/100",
            "premium": false
          },
          "B": {
            "outcome": "üì° –¢–´ –°–¢–ê–õ: –í–°–ï–ú–ò–†–ù–´–ô WI-FI\n\n–ü—Ä–µ–≤—Ä–∞—Ç–∏–ª –ù–õ–û –≤ —Ä–æ—É—Ç–µ—Ä. –í–µ—Å—å —Ä–∞–π–æ–Ω –≤ –æ–Ω–ª–∞–π–Ω–µ.\n–¢—ã ‚Äî –≥–µ—Ä–æ–π –¥–≤–æ—Ä–∞.\n\nüì∂ –°–∏–≥–Ω–∞–ª: 100/100",
            "premium": false
          }
        }
      }
    };

    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    let userId = 'demo123';
    const APP_ID = '54388761';
    let isSharing = false;
    let currentStoryImageUrl = null;

    // –§–£–ù–ö–¶–ò–ò
    function isInVK() {
      const params = new URLSearchParams(window.location.search);
      return params.has('vk_user_id') || 
             navigator.userAgent.includes('VK') || 
             window.location.hostname.includes('vk.com');
    }

    function updateStatus(text) {
      const statusEl = document.getElementById('status');
      if (statusEl) {
        statusEl.innerHTML = text;
        console.log('Status:', text);
      }
    }

    function showRandomStory() {
      const storyId = "1";
      const story = STORIES[storyId];
      
      if (!story) {
        document.getElementById('game').innerHTML = '<p>–û—à–∏–±–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>';
        return;
      }

      let html = `<div class="story-box">${story.text}</div>`;
      
      for (const key in story.options) {
        const opt = story.options[key];
        html += `<button class="btn btn-free" onclick="showResult('${storyId}', '${key}')">${key}</button>`;
      }
      
      document.getElementById('game').innerHTML = html;
    }

    function showResult(storyId, choice) {
      const outcome = STORIES[storyId].options[choice].outcome;
      const title = getTitle(outcome);
      
      const resultHtml = `
        <div class="result" id="resultBox">
          ${outcome}
          <div class="rarity">üíé –†–µ–¥–∫–æ—Å—Ç—å: –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è</div>
        </div>
        <button class="btn btn-share" onclick="prepareForSharing()">üì≤ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
        <button class="btn btn-free" onclick="showRandomStory()">üîÅ –°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
      `;
      
      document.getElementById('game').innerHTML = resultHtml;
    }

    function getTitle(outcome) {
      const lines = outcome.split('\n');
      for (let line of lines) {
        if (line.includes("–¢–´ –°–¢–ê–õ: ")) {
          return line.split("–¢–´ –°–¢–ê–õ: ")[1].replace(/[üíéüèÜüåÄ‚ú®]/g, '').trim();
        }
      }
      return "–¢–∞–π–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å";
    }

    // –°–û–ó–î–ê–ù–ò–ï –£–ü–†–û–©–ï–ù–ù–û–ô –ö–ê–†–¢–ò–ù–ö–ò (–º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä)
    function createSimpleStoryImage() {
      const canvas = document.createElement('canvas');
      canvas.width = 1080;
      canvas.height = 1920;
      const ctx = canvas.getContext('2d');
      
      // –ü–†–û–°–¢–û–ô –§–û–ù (–±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤)
      ctx.fillStyle = '#6a11cb';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      ctx.fillStyle = '#2575fc';
      ctx.beginPath();
      ctx.arc(canvas.width / 2, 300, 150, 0, Math.PI * 2);
      ctx.fill();
      
      // –¢–µ–∫—Å—Ç
      ctx.fillStyle = 'white';
      ctx.font = 'bold 80px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      ctx.fillText('üî•', canvas.width / 2, 300);
      ctx.font = 'bold 70px Arial';
      ctx.fillText('–°–£–î–¨–ë–ê', canvas.width / 2, 450);
      ctx.fillText('–ó–ê 10 –°–ï–ö–£–ù–î', canvas.width / 2, 530);
      
      // –†–µ–∑—É–ª—å—Ç–∞—Ç
      const outcome = document.querySelector('.result').textContent;
      const title = getTitle(outcome);
      
      ctx.font = 'bold 60px Arial';
      ctx.fillStyle = '#ffcc00';
      ctx.fillText('–¢–´ –°–¢–ê–õ:', canvas.width / 2, 700);
      
      ctx.font = 'bold 80px Arial';
      ctx.fillStyle = '#ff416c';
      ctx.fillText(title.toUpperCase(), canvas.width / 2, 800);
      
      // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
      const textWithoutTitle = outcome.replace(`–¢–´ –°–¢–ê–õ: ${title}`, '').trim();
      ctx.font = 'bold 40px Arial';
      ctx.fillStyle = 'white';
      ctx.textAlign = 'left';
      
      const lines = textWithoutTitle.split('\n').filter(line => line.trim() !== '');
      let y = 950;
      
      for (let i = 0; i < Math.min(lines.length, 6); i++) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 6 —Å—Ç—Ä–æ–∫–∞–º–∏
        ctx.fillText(lines[i], 80, y);
        y += 70;
      }
      
      // –°—Å—ã–ª–∫–∞
      ctx.textAlign = 'center';
      ctx.font = 'bold 50px Arial';
      ctx.fillStyle = '#4CAF50';
      ctx.fillText('vk.com/app' + APP_ID, canvas.width / 2, 1650);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∫–∞—Ä—Ç–∏–Ω–∫–∏
      currentStoryImageUrl = canvas.toDataURL('image/png');
      return currentStoryImageUrl;
    }

    // –ü–û–î–ì–û–¢–û–í–ö–ê –ö –®–ï–†–ò–ù–ì–£
    async function prepareForSharing() {
      updateStatus('üîÑ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç...');
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
      const imageUrl = createSimpleStoryImage();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —à–µ—Ä–∏–Ω–≥–∞
      showShareOptions(imageUrl);
      updateStatus('‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–µ–ª–∏—Ç—å—Å—è');
    }

    // –ü–û–ö–ê–ó –í–ê–†–ò–ê–ù–¢–û–í –®–ï–†–ò–ù–ì–ê
    function showShareOptions(imageUrl) {
      const title = getTitle(document.querySelector('.result').textContent);
      const shareText = `üî• –Ø —Å—Ç–∞–ª: ${title}!\n\n–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ üëá\nhttps://vk.com/app${APP_ID}`;
      
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      document.getElementById('game').innerHTML = `
        <div class="result" id="resultBox">
          ${document.querySelector('.result').innerHTML}
        </div>
        
        <div class="share-options">
          <h3>üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
          
          <div class="share-method">
            <h4>ü§ñ <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</strong> (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü–ö)</h4>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ VK API:</p>
            <button class="btn" style="background: linear-gradient(45deg, #6a11cb, #2575fc); margin-top: 10px; width: 100%;" 
                    onclick="tryAutoCreateStory()">
              üöÄ –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            </button>
          </div>
          
          <div class="share-method">
            <h4>üì± <strong>–î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö</strong></h4>
            <p>${isMobile ? '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ—ë, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ VK –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é:' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É:'}</p>
            <img src="${imageUrl}" class="image-preview" 
                 onclick="downloadImage('${imageUrl.replace(/'/g, "\\'")}', 'sudyba-${title}.png')"
                 style="cursor: pointer;">
            <button class="btn" style="background: linear-gradient(45deg, #4CAF50, #8BC34A); margin-top: 10px; width: 100%;" 
                    onclick="downloadImage('${imageUrl.replace(/'/g, "\\'")}', 'sudyba-${title}.png')">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
            </button>
          </div>
          
          <div class="share-method">
            <h4>üìã <strong>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</strong></h4>
            <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–º:</p>
            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; word-break: break-all;">
              ${shareText}
            </div>
            <button class="btn" style="background: linear-gradient(45deg, #ff9800, #ff5722); margin-top: 10px; width: 100%;" 
                    onclick="copyToClipboard('${shareText.replace(/\n/g, '\\n').replace(/'/g, "\\'")}')">
              üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
            </button>
          </div>
          
          ${isMobile ? `
          <div class="share-method">
            <h4>üîó <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω</strong></h4>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–µ—Ä–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</p>
            <button class="btn" style="background: linear-gradient(45deg, #9C27B0, #673AB7); margin-top: 10px; width: 100%;" 
                    onclick="shareViaNative()">
              üì≤ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω
            </button>
          </div>
          ` : ''}
        </div>
        
        <button class="btn btn-free" onclick="showRandomStory()">üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</button>
      `;
    }

    // –ü–û–ü–´–¢–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –°–û–ó–î–ê–ù–ò–Ø
    async function tryAutoCreateStory() {
      if (isSharing) return;
      isSharing = true;
      
      updateStatus('üîÑ –ü—ã—Ç–∞—é—Å—å —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ VK API...');
      
      try {
        if (!window.vkBridge) {
          updateStatus('‚ùå VK Bridge –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
          alert('VK Bridge –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã.');
          return;
        }
        
        await window.vkBridge.send('VKWebAppInit', {});
        updateStatus('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
        const result = await window.vkBridge.send('VKWebAppShowStoryBox', {
          background_type: 'image',
          url: currentStoryImageUrl || createSimpleStoryImage()
        });
        
        if (result && result.result) {
          updateStatus('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
          setTimeout(() => {
            alert('üéâ –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∏—Å—Ç–æ—Ä–∏–∏ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ.');
            showRandomStory();
            updateStatus('');
          }, 1000);
        } else {
          throw new Error('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
        
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
        if (error.error_message) {
          errorMessage = error.error_message;
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        updateStatus(`‚ùå ${errorMessage}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (errorMessage.includes('denied') || errorMessage.includes('–æ—Ç–∫–∞–∑–∞–Ω–æ')) {
          alert('–í—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã.');
        } else if (errorMessage.includes('image')) {
          alert('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤—Ä—É—á–Ω—É—é.');
        } else {
          alert('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã.');
        }
        
      } finally {
        isSharing = false;
      }
    }

    // –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ö–ê–†–¢–ò–ù–ö–ò
    function downloadImage(dataUrl, filename) {
      try {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
          alert(`‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ "${filename}"!\n\n–¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π—Ç–µ VK:\n1. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"\n2. –î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É\n3. –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é!`);
        }, 500);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –∏ –≤—ã–±—Ä–∞—Ç—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫".');
      }
    }

    // –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê
    function copyToClipboard(text) {
      const unescapedText = text.replace(/\\n/g, '\n');
      navigator.clipboard.writeText(unescapedText)
        .then(() => {
          alert('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏—é VK.');
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
          alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
        });
    }

    // –°–ò–°–¢–ï–ú–ù–´–ô –®–ï–†–ò–ù–ì (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
    async function shareViaNative() {
      if (navigator.share) {
        try {
          const title = getTitle(document.querySelector('.result').textContent);
          const shareText = `üî• –Ø —Å—Ç–∞–ª: ${title}!\n\n–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ üëá\nhttps://vk.com/app${APP_ID}`;
          
          await navigator.share({
            title: '–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ "–°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥"',
            text: shareText,
            url: `https://vk.com/app${APP_ID}`
          });
          
          alert('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å!');
        } catch (error) {
          console.log('–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —à–µ—Ä–∏–Ω–≥–∞:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–µ—Ä–∏–Ω–≥.');
        }
      } else {
        alert('–°–∏—Å—Ç–µ–º–Ω—ã–π —à–µ—Ä–∏–Ω–≥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
      }
    }

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    async function initApp() {
      updateStatus('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
      
      if (isInVK()) {
        updateStatus('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω VK');
        
        try {
          if (window.vkBridge) {
            updateStatus('‚úÖ VK Bridge –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            await window.vkBridge.send('VKWebAppInit', {});
            updateStatus('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ');
            
            try {
              const userInfo = await window.vkBridge.send('VKWebAppGetUserInfo');
              userId = userInfo.id;
              updateStatus(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userInfo.first_name}`);
            } catch (e) {
              console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', e);
              updateStatus('üë§ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
            }
          } else {
            updateStatus('‚ö†Ô∏è VK Bridge –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –Ω–æ –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
          }
          
          showRandomStory();
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
          updateStatus('‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ');
          showRandomStory();
        }
      } else {
        updateStatus('üåê –†–µ–∂–∏–º: –î–µ–º–æ (–Ω–µ –≤ VK)');
        showRandomStory();
      }
    }

    // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
