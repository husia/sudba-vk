<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer">
  <title>–°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</title>
  
  <!-- –§–ò–ö–° –î–õ–Ø 403 –û–®–ò–ë–ö–ò -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://*.vk.com https://*.vk-portal.net https://api.vk.com https://unpkg.com https://vk.com;
    script-src 'self' 'unsafe-inline' https://unpkg.com https://*.vk.com https://vk.com;
    style-src 'self' 'unsafe-inline' https://*.vk.com https://vk.com;
    img-src 'self' data: https://*.vk.com https://*.vk-portal.net https://vk.com https://i.imgur.com;
    connect-src 'self' https://*.vk.com https://api.vk.com https://husia.github.io https://vk.com;
    frame-src 'self' https://*.vk.com https://vk.com;
    child-src 'self' https://*.vk.com https://vk.com;
    worker-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
  ">
  
  <!-- –°–ö–†–ò–ü–¢ –î–õ–Ø –ü–û–õ–ù–û–ì–û –û–ë–•–û–î–ê 403 -->
  <script>
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ stats.vk-portal.net –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
    if (window.top !== window.self) {
      try {
        const originalFetch = window.fetch;
        window.fetch = async (url, options) => {
          if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
            console.log('üö´ –ó–∞–ø—Ä–æ—Å –∫ stats.vk-portal.net –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–≥—Ä—É–∑–∫–∏');
            return {
              ok: true,
              status: 200,
              json: () => Promise.resolve({ success: true }),
              text: () => Promise.resolve('blocked')
            };
          }
          return originalFetch(url, options);
        };
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ stats:', e);
      }
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    .story-box {
      background: rgba(0,0,0,0.2);
      border-radius: 18px;
      padding: 20px;
      margin: 20px 0;
      font-size: 18px;
      line-height: 1.5;
      white-space: pre-wrap;
      border: 1px dashed rgba(255,255,255,0.3);
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn-free {
      background: linear-gradient(45deg, #ff9a9e, #fad0c4);
      color: #8b4513;
    }
    .btn-premium {
      background: linear-gradient(45deg, #a1c4fd, #c2e9fb);
      color: #2c3e50;
      position: relative;
      overflow: hidden;
    }
    .btn-premium::after {
      content: "üíé";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
    }
    .btn-share {
      background: linear-gradient(45deg, #43e97b, #38f9d7);
      color: #0a3d30;
    }
    .result {
      background: rgba(0,0,0,0.25);
      border-radius: 20px;
      padding: 24px;
      margin: 24px 0;
      font-size: 18px;
      line-height: 1.6;
      border: 2px solid #ffcc00;
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .rarity {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.2);
    }
    .friends {
      background: rgba(0,0,0,0.2);
      padding: 16px;
      border-radius: 16px;
      margin: 16px 0;
      font-style: italic;
    }
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
    }
    .footer {
      margin-top: 20px;
      font-size: 14px;
      opacity: 0.8;
    }
    .demo-note {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      margin-top: 15px;
    }
    .loading {
      font-size: 20px;
      margin: 40px 0;
      animation: pulse 1.5s infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• –°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</h1>
    <div id="game">
      <div class="loading">‚ú® –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–π...</div>
    </div>
    <div class="footer">–°–æ–∑–¥–∞–Ω–æ —Å –∞–±—Å—É—Ä–¥–æ–º –∏ –ª—é–±–æ–≤—å—é ‚ù§Ô∏è</div>
  </div>

  <div class="confetti" id="confetti"></div>

  <script>
    // –≠–ö–°–¢–†–ï–ù–ù–´–ô –û–ë–•–û–î 403
    (function() {
      const blockStats = () => {
        const originalFetch = window.fetch;
        window.fetch = async (url, options) => {
          if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
            return {
              ok: true,
              status: 200,
              json: () => Promise.resolve({ success: true }),
              text: () => Promise.resolve('blocked')
            };
          }
          return originalFetch(url, options);
        };
      };
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
      blockStats();
      
      // –ò –∫–∞–∂–¥—ã–µ 500–º—Å (–Ω–∞ —Å–ª—É—á–∞–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏)
      setInterval(blockStats, 500);
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º XHR
      const originalXhr = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXhr();
        const open = xhr.open;
        xhr.open = function(method, url) {
          if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
            this.onload = () => {
              this.responseText = JSON.stringify({ success: true });
              this.status = 200;
              this.readyState = 4;
            };
            this.send = () => {};
          }
          return open.apply(this, arguments);
        };
        return xhr;
      };
    })();
    
    // ======================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ======================
    let STORIES = {};
    let userId = 'demo123';
    const APP_ID = '5198765432'; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –†–ï–ê–õ–¨–ù–´–ô APP ID

    // ======================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ======================
    function isInVK() {
      return window.top !== window.self || 
             window.location.search.includes('vk_') || 
             window.navigator.userAgent.includes('VK');
    }

    function getVKParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        vkUserId: params.get('vk_user_id'),
        vkAppId: params.get('vk_app_id'),
        vkIsAppUser: params.get('vk_is_app_user'),
        vkRef: params.get('vk_ref'),
        vkAccessToken: params.get('vk_access_token'),
        vkAuth: params.get('vk_auth')
      };
    }

    // ======================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ï–ó –°–¢–ê–¢–ò–°–¢–ò–ö–ò
    // ======================
    async function initApp() {
      // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º referrer
      try {
        if ('referrerPolicy' in document) {
          document.referrerPolicy = 'no-referrer';
        }
        if (window.top !== window.self) {
          window.top.document.referrerPolicy = 'no-referrer';
        }
      } catch (e) {
        console.log('Referrer policy error:', e);
      }

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ stats.vk-portal.net
      const originalFetch = window.fetch;
      window.fetch = async (url, options = {}) => {
        if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
          console.log('üö´ –ó–∞–ø—Ä–æ—Å –∫ stats.vk-portal.net –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
          return {
            ok: true,
            status: 200,
            json: () => Promise.resolve({ success: true }),
            text: () => Promise.resolve('blocked')
          };
        }
        return originalFetch(url, options);
      };

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏–∏
      try {
        const response = await fetch('stories.json', {
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Accept': 'application/json'
          }
        });
        STORIES = await response.json();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–π:', error);
        STORIES = {
          "1": {
            "text": "üî• –¢—ã –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Ç–µ–ª–µ –ò–ò, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –º–µ–º–∞–º–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π...\n\n–ß—Ç–æ –∑–∞–ø—É—Å—Ç–∏—à—å?",
            "options": {
              "A": {
                "outcome": "üí• –¢–´ –°–¢–ê–õ: –ú–ï–ú-–ë–û–ì\n\n–¢–≤–æ–π –º–µ–º ¬´–ü–ª–∞—á—å –∫–∞–∫ –ë–∞–π–¥–µ–Ω –Ω–∞ –±–∞–ª–∞–ª–∞–π–∫–µ¬ª\n–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ 2.1 –º–ª—Ä–¥ —á–µ–ª–æ–≤–µ–∫.\n–¢—ã –∑–∞–ø—Ä–µ—â—ë–Ω –≤ 3 –≥–∞–ª–∞–∫—Ç–∏–∫–∞—Ö.\n\nüèÜ –£—Ä–æ–≤–µ–Ω—å —Ö–∞–æ—Å–∞: 999/100",
                "premium": false
              },
              "B": {
                "outcome": "üïäÔ∏è –¢–´ –°–¢–ê–õ: –ú–ò–†–û–¢–í–û–†–ï–¶ –ú–ï–ú–û–í\n\n–¢—ã —É–±–µ–¥–∏–ª –≤—Å–µ—Ö, —á—Ç–æ ¬´–∫–æ—Ç —Å –æ–≥—É—Ä—Ü–æ–º¬ª ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ.\n–ú–∏—Ä –æ–±—ä–µ–¥–∏–Ω–∏–ª—Å—è –≤ —Ö–æ—Ö–æ—Ç–µ.\n\n‚òÆÔ∏è –£—Ä–æ–≤–µ–Ω—å –º–∏—Ä–∞: 100/100",
                "premium": false
              }
            }
          }
        };
      }

      const vkParams = getVKParams();
      const isRealVK = vkParams.vkUserId && vkParams.vkAppId;
      
      if (isRealVK && isInVK()) {
        try {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º VK Bridge –ë–ï–ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          const vkModule = await import('https://unpkg.com/@vkontakte/vk-bridge@2.12.2/dist/vk-bridge.umd.js');
          const { bridge } = vkModule.default || vkModule;
          
          // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          if (bridge.on) {
            bridge.on('VKWebAppConversionHit', (data) => {
              console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –∏ –æ—Ç–º–µ–Ω–µ–Ω–∞', data);
              return false;
            });
          }
          
          await bridge.send('VKWebAppInit');
          
          // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–ï–ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          const user = await bridge.send('VKWebAppGetUserInfo');
          userId = user.id;
          
          showRandomStory();
        } catch (e) {
          console.error('VK Error:', e);
          userId = 'demo123';
          showRandomStory();
          showDemoNote();
        }
      } else {
        userId = 'demo123';
        showRandomStory();
        showDemoNote();
      }
    }

    // ======================
    // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´
    // ======================
    function getRandomFreeStoryId() {
      const freeIds = Object.keys(STORIES).filter(id => 
        !Object.values(STORIES[id].options).some(opt => opt.premium)
      );
      return freeIds.length > 0 ? freeIds[Math.floor(Math.random() * freeIds.length)] : "1";
    }

    function showRandomStory(storyId = null) {
      const id = storyId || getRandomFreeStoryId();
      const story = STORIES[id];
      if (!story) {
        document.getElementById('game').innerHTML = '<p>–û—à–∏–±–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>';
        return;
      }

      let html = `<div class="story-box">${story.text}</div>`;

      for (const key in story.options) {
        const opt = story.options[key];
        if (opt.premium) {
          html += `<button class="btn btn-premium" onclick="premiumStub('${id}', '${key}')">üíé ${key} (–ü—Ä–µ–º–∏—É–º)</button>`;
        } else {
          html += `<button class="btn btn-free" onclick="showResult('${id}', '${key}')">${key}</button>`;
        }
      }

      document.getElementById('game').innerHTML = html;
    }

    function showResult(storyId, choice) {
      const outcome = STORIES[storyId].options[choice].outcome;
      
      const friendsList = [
        "@ivan ‚Üí '–ö–æ—Ç-—Ö–∞–∫–µ—Ä'",
        "@maria ‚Üí '–ò–ò-–±–∞—Ä–∏—Å—Ç–∞'",
        "@petr ‚Üí '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –ú–∞—Ä—Å–∞'",
        "@lena ‚Üí '–ù–µ–π—Ä–æ-—à–∞–º–∞–Ω'",
        "@barsik ‚Üí '–¢–∞–π–Ω—ã–π –∞–≥–µ–Ω—Ç'"
      ];
      const shuffled = [...friendsList].sort(() => 0.5 - Math.random());
      const friends = shuffled.slice(0, 2).join('\n');
      
      let rarity = "–û–±—ã—á–Ω–∞—è";
      if (outcome.includes("999/100") || outcome.includes("MAX")) rarity = "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è";
      else if (outcome.includes("9")) rarity = "–≠–ø–∏—á–µ—Å–∫–∞—è";

      const resultHtml = `
        <div class="result" id="resultBox">
          ${outcome}
          <div class="rarity">üíé –†–µ–¥–∫–æ—Å—Ç—å: ${rarity}</div>
        </div>
        <div class="friends">
          üëÄ –í–ê–®–ò –î–†–£–ó–¨–Ø:<br>${friends}<br>
          ‚Äî –í—ã ‚Üí <b>${getTitle(outcome)}</b> üëë
        </div>
        <button class="btn btn-share" onclick="shareResult()">üì≤ –°—Ä–∞–≤–Ω–∏—Ç—å —Å—É–¥—å–±—ã?</button>
        <button class="btn btn-free" onclick="showRandomStory()">üîÅ –°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
        <button class="btn btn-premium" onclick="showPremium()">üíé –ü—Ä–µ–º–∏—É–º-—Å—É–¥—å–±—ã</button>
      `;

      document.getElementById('game').innerHTML = resultHtml;
      
      if (rarity === "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è") {
        triggerConfetti();
      }
    }

    function getTitle(outcome) {
      const lines = outcome.split('\n');
      for (let line of lines) {
        if (line.includes("–¢–´ –°–¢–ê–õ: ")) {
          return line.split("–¢–´ –°–¢–ê–õ: ")[1].replace(/[üíéüèÜüåÄ‚ú®]/g, '').trim();
        }
      }
      return "–¢–∞–π–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å";
    }

    function shareResult() {
      const link = isInVK() 
        ? `https://vk.com/app${APP_ID}?ref=${userId}`
        : `https://vk.com/app${APP_ID}?ref=demo123`;
      
      if (isInVK() && window.vkBridge) {
        try {
          window.vkBridge.send('VKWebAppShare', { link });
        } catch (e) {
          fallbackShare(link);
        }
      } else {
        fallbackShare(link);
      }
    }

    function fallbackShare(link) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          alert('üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!\n' + link);
        });
      } else {
        prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', link);
      }
    }

    function showPremium() {
      const premiumIds = Object.keys(STORIES).filter(id => 
        Object.values(STORIES[id].options).some(opt => opt.premium)
      );
      if (premiumIds.length > 0) {
        const randomId = premiumIds[Math.floor(Math.random() * premiumIds.length)];
        showRandomStory(randomId);
      }
    }

    function premiumStub(storyId, choice) {
      alert('‚ú® –ü—Ä–µ–º–∏—É–º-–∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–æ—Ä–æ! (VK Pay –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω)');
      showResult(storyId, choice);
    }

    function triggerConfetti() {
      const confettiContainer = document.getElementById('confetti');
      confettiContainer.innerHTML = '';
      confettiContainer.style.opacity = '1';
      
      for (let i = 0; i < 50; i++) {
        const emoji = ['üéâ', 'üíé', '‚ú®', 'üöÄ', 'üëë'][Math.floor(Math.random() * 5)];
        const confetti = document.createElement('div');
        confetti.textContent = emoji;
        Object.assign(confetti.style, {
          position: 'absolute',
          fontSize: (Math.random() * 20 + 10) + 'px',
          left: Math.random() * 100 + 'vw',
          top: '-20px',
          opacity: String(Math.random()),
          zIndex: '100'
        });
        confettiContainer.appendChild(confetti);
        
        const duration = Math.random() * 3 + 2;
        const anim = confetti.animate([
          { transform: 'translateY(0) rotate(0deg)', opacity: '1' },
          { 
            transform: `translateY(${window.innerHeight}px) rotate(${360 * (Math.random() > 0.5 ? 1 : -1)}deg)`, 
            opacity: '0' 
          }
        ], {
          duration: duration * 1000,
          easing: 'cubic-bezier(0,0.5,0.5,1)'
        });
      }
      
      setTimeout(() => {
        confettiContainer.style.opacity = '0';
      }, 5000);
    }

    function showDemoNote() {
      const note = document.createElement('div');
      note.className = 'demo-note';
      note.innerHTML = 'üí° –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º<br>–í–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –±—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª';
      document.querySelector('.container').appendChild(note);
    }

    // ======================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
    // ======================
    document.addEventListener('DOMContentLoaded', () => {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º VK Bridge
      if (isInVK()) {
        import('https://unpkg.com/@vkontakte/vk-bridge@2.12.2/dist/vk-bridge.umd.js')
          .then(module => {
            window.vkBridge = module.default || module;
            initApp();
          })
          .catch(e => {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å VK Bridge:', e);
            initApp();
          });
      } else {
        initApp();
      }
    });
  </script>
</body>
</html>
