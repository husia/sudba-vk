<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer">
  <title>–°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</title>
  
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º VK Bridge —Å—Ä–∞–∑—É –≤ head -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.25);
    }
    h1 {
      font-size: 32px;
      margin-bottom: 24px;
      text-shadow: 0 3px 6px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
      background: linear-gradient(45deg, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.04); }
      100% { transform: scale(1); }
    }
    .story-box {
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border-radius: 20px;
      padding: 24px;
      margin: 24px 0;
      font-size: 20px;
      line-height: 1.6;
      white-space: pre-wrap;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn {
      display: block;
      width: 100%;
      padding: 18px;
      margin: 16px 0;
      border: none;
      border-radius: 18px;
      font-size: 19px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.3);
    }
    .btn:active {
      transform: translateY(-2px);
    }
    .btn-choice {
      background: linear-gradient(45deg, #FF6B6B, #FF8E53);
      color: white;
    }
    .btn-choice:hover {
      background: linear-gradient(45deg, #FF5252, #FF7B3A);
    }
    .btn-share {
      background: linear-gradient(45deg, #FF416C, #FF4B2B);
      color: white;
      box-shadow: 0 8px 25px rgba(255, 65, 108, 0.4);
    }
    .btn-share:hover {
      background: linear-gradient(45deg, #FF2B60, #FF3A1A);
      box-shadow: 0 12px 30px rgba(255, 65, 108, 0.6);
    }
    .btn-vip {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #8B4513;
      position: relative;
    }
    .btn-vip::after {
      content: "‚ú®";
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
    }
    .btn-vip:hover {
      background: linear-gradient(45deg, #FFC800, #FF9500);
    }
    .btn-download {
      background: linear-gradient(45deg, #4CAF50, #2E7D32);
      color: white;
    }
    .btn-download:hover {
      background: linear-gradient(45deg, #43A047, #1B5E20);
    }
    .btn-copy {
      background: linear-gradient(45deg, #9C27B0, #673AB7);
      color: white;
    }
    .btn-copy:hover {
      background: linear-gradient(45deg, #8E24AA, #5E35B1);
    }
    .result {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
      border-radius: 22px;
      padding: 28px;
      margin: 28px 0;
      font-size: 20px;
      line-height: 1.7;
      border: 2px solid #FFD700;
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.25);
      animation: fadeIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .rarity {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 800;
      background: linear-gradient(45deg, #FF416C, #FF4B2B);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
    }
    .footer {
      margin-top: 25px;
      font-size: 15px;
      opacity: 0.9;
      color: rgba(255,255,255,0.8);
    }
    .loading {
      font-size: 22px;
      margin: 45px 0;
      animation: pulse 1.8s infinite;
      color: #FFD700;
    }
    .status {
      margin-top: 25px;
      padding: 15px;
      background: rgba(0,0,0,0.25);
      border-radius: 14px;
      font-size: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .warning {
      background: linear-gradient(135deg, rgba(255, 165, 0, 0.25), rgba(255, 193, 7, 0.15));
      border: 2px solid #FF9800;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    .warning-title {
      color: #FFD700;
      font-weight: 800;
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .warning-title::before {
      content: "‚ö†Ô∏è";
      font-size: 24px;
    }
    .instructions {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.25), rgba(139, 195, 74, 0.15));
      border: 2px solid #4CAF50;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
    }
    .instructions-title {
      color: #C8E6C9;
      font-weight: 800;
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .instructions-title::before {
      content: "üì±";
      font-size: 24px;
    }
    .result-image {
      width: 100%;
      border-radius: 18px;
      margin: 20px 0;
      border: 3px solid rgba(255,255,255,0.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .result-image:hover {
      transform: scale(1.02);
    }
    .emoji-badge {
      display: inline-block;
      font-size: 28px;
      margin: 0 8px;
      vertical-align: middle;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="emoji-badge">üî•</span> –°–£–î–¨–ë–ê –ó–ê 10 –°–ï–ö–£–ù–î <span class="emoji-badge">‚ú®</span></h1>
    <div id="game">
      <div class="loading">‚ú® –ú–∞–≥–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
    </div>
    <div id="status" class="status"></div>
    <div class="footer">–°–æ–∑–¥–∞–Ω–æ —Å –±–µ–∑—É–º–∏–µ–º –∏ –ª—é–±–æ–≤—å—é ‚ù§Ô∏è | –¢–≤–æ—è —Å—É–¥—å–±–∞ –∂–¥—ë—Ç!</div>
  </div>

  <script>
    // –ò–°–¢–û–†–ò–ò
    const STORIES = {
      "1": {
        "text": "üî• –¢—ã –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Ç–µ–ª–µ –ò–ò, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –º–µ–º–∞–º–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π...\n\n–ß—Ç–æ –∑–∞–ø—É—Å—Ç–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üí• –¢–´ –°–¢–ê–õ: –ú–ï–ú-–ë–û–ì\n\n–¢–≤–æ–π –º–µ–º ¬´–ü–ª–∞—á—å –∫–∞–∫ –ë–∞–π–¥–µ–Ω –Ω–∞ –±–∞–ª–∞–ª–∞–π–∫–µ¬ª\n–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ 2.1 –º–ª—Ä–¥ —á–µ–ª–æ–≤–µ–∫.\n–¢—ã –∑–∞–ø—Ä–µ—â—ë–Ω –≤ 3 –≥–∞–ª–∞–∫—Ç–∏–∫–∞—Ö.\n\nüèÜ –£—Ä–æ–≤–µ–Ω—å —Ö–∞–æ—Å–∞: 999/100",
            "premium": false
          },
          "B": {
            "outcome": "üïäÔ∏è –¢–´ –°–¢–ê–õ: –ú–ò–†–û–¢–í–û–†–ï–¶ –ú–ï–ú–û–í\n\n–¢—ã —É–±–µ–¥–∏–ª –≤—Å–µ—Ö, —á—Ç–æ ¬´–∫–æ—Ç —Å –æ–≥—É—Ä—Ü–æ–º¬ª ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ.\n–ú–∏—Ä –æ–±—ä–µ–¥–∏–Ω–∏–ª—Å—è –≤ —Ö–æ—Ö–æ—Ç–µ.\n\n‚òÆÔ∏è –£—Ä–æ–≤–µ–Ω—å –º–∏—Ä–∞: 100/100",
            "premium": false
          }
        }
      },
      "2": {
        "text": "üõ∏ –¢—ã –Ω–∞—à—ë–ª –ù–õ–û –≤ –≥–∞—Ä–∞–∂–µ. –ó–∞–≤–æ–¥–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üöÄ –¢–´ –°–¢–ê–õ: –ú–ê–†–°–ò–ê–ù–°–ö–ò–ú –ü–ò–¶–¶–ï–†–û–ú\n\n–û—Ç–∫—Ä—ã–ª –ø–∏—Ü—Ü–µ—Ä–∏—é –Ω–∞ –ö—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ.\n–ú–∞—Ä—Å–∏–∞–Ω–µ —Ç–µ–ø–µ—Ä—å –µ–¥—è—Ç —Ç–æ–ª—å–∫–æ ¬´–ü–µ–ø–ø–µ—Ä–æ–Ω–∏-2077¬ª.\n\nüçï –£—Ä–æ–≤–µ–Ω—å –≤–∫—É—Å–∞: 100/100",
            "premium": false
          },
          "B": {
            "outcome": "üì° –¢–´ –°–¢–ê–õ: –í–°–ï–ú–ò–†–ù–´–ô WI-FI\n\n–ü—Ä–µ–≤—Ä–∞—Ç–∏–ª –ù–õ–û –≤ —Ä–æ—É—Ç–µ—Ä. –í–µ—Å—å —Ä–∞–π–æ–Ω –≤ –æ–Ω–ª–∞–π–Ω–µ.\n–¢—ã ‚Äî –≥–µ—Ä–æ–π –¥–≤–æ—Ä–∞.\n\nüì∂ –°–∏–≥–Ω–∞–ª: 100/100",
            "premium": false
          }
        }
      }
    };

    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    let userId = 'demo123';
    const APP_ID = '54388761';
    let isSharing = false;

    // –§–£–ù–ö–¶–ò–ò
    function isInVK() {
      const params = new URLSearchParams(window.location.search);
      return params.has('vk_user_id') || 
             navigator.userAgent.includes('VK') || 
             window.location.hostname.includes('vk.com');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ VK
    function isMobileVK() {
      const userAgent = navigator.userAgent.toLowerCase();
      const isMobile = /mobile|android|iphone|ipad|ipod/.test(userAgent);
      const isVK = /vk/.test(userAgent) || window.location.hostname.includes('vk.com');
      const params = new URLSearchParams(window.location.search);
      const hasVKParams = params.has('vk_user_id');
      
      return isMobile && isVK && hasVKParams;
    }

    function updateStatus(text) {
      const statusEl = document.getElementById('status');
      if (statusEl) {
        statusEl.innerHTML = text;
        console.log('Status:', text);
      }
    }

    function showRandomStory() {
      const storyId = "1";
      const story = STORIES[storyId];
      
      if (!story) {
        document.getElementById('game').innerHTML = '<p>–û—à–∏–±–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>';
        return;
      }

      let html = `<div class="story-box">${story.text}</div>`;
      
      for (const key in story.options) {
        const opt = story.options[key];
        html += `<button class="btn btn-choice" onclick="showResult('${storyId}', '${key}')">${key}</button>`;
      }
      
      document.getElementById('game').innerHTML = html;
      updateStatus('üéØ –í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Å—É–¥—å–±—É!');
    }

    function showResult(storyId, choice) {
      const outcome = STORIES[storyId].options[choice].outcome;
      const title = getTitle(outcome);
      
      const resultHtml = `
        <div class="result" id="resultBox">
          ${outcome}
          <div class="rarity">‚ö° –†–ï–î–ö–û–°–¢–¨: –õ–ï–ì–ï–ù–î–ê–†–ù–ê–Ø</div>
        </div>
        <div class="instructions">
          <div class="instructions-title">üéâ –¢–≤–æ—è —Å—É–¥—å–±–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!</div>
          –ü–æ–¥–µ–ª–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏ ‚Äî –ø—É—Å—Ç—å –æ–Ω–∏ —Ç–æ–∂–µ —É–∑–Ω–∞—é—Ç —Å–≤–æ—é —Å—É–¥—å–±—É!
        </div>
        <button class="btn btn-share" onclick="createAndShareStory()">
          üì≤ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—è—Ö
        </button>
        <button class="btn btn-vip" onclick="showRandomStory()">
          üîÑ –£–∑–Ω–∞—Ç—å –¥—Ä—É–≥—É—é —Å—É–¥—å–±—É
        </button>
      `;
      
      document.getElementById('game').innerHTML = resultHtml;
      updateStatus('‚ú® –¢–≤–æ—è —Å—É–¥—å–±–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞!');
    }

    function getTitle(outcome) {
      const lines = outcome.split('\n');
      for (let line of lines) {
        if (line.includes("–¢–´ –°–¢–ê–õ: ")) {
          return line.split("–¢–´ –°–¢–ê–õ: ")[1].replace(/[üíéüèÜüåÄ‚ú®üí•üïäÔ∏èüöÄüì°]/g, '').trim();
        }
      }
      return "–¢–ê–ô–ù–ê–Ø –õ–ò–ß–ù–û–°–¢–¨";
    }

    // –°–û–ó–î–ê–ù–ò–ï –ö–ê–†–¢–ò–ù–ö–ò –î–õ–Ø VK
    function createStoryImage() {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 1080;
        canvas.height = 1920;
        const ctx = canvas.getContext('2d');
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#6a11cb');
        gradient.addColorStop(1, '#2575fc');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –¢–µ–∫—Å—Ç
        const outcome = document.querySelector('.result').textContent;
        const title = getTitle(outcome);
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ctx.fillStyle = 'white';
        ctx.font = 'bold 120px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        ctx.fillText('üî•', canvas.width / 2, 250);
        ctx.font = 'bold 80px Arial';
        ctx.fillText('–°–£–î–¨–ë–ê', canvas.width / 2, 400);
        ctx.fillText('–ó–ê 10 –°–ï–ö–£–ù–î', canvas.width / 2, 500);
        
        // –†–µ–∑—É–ª—å—Ç–∞—Ç
        ctx.font = 'bold 70px Arial';
        ctx.fillStyle = '#ffcc00';
        ctx.fillText('–¢–´ –°–¢–ê–õ:', canvas.width / 2, 700);
        
        ctx.font = 'bold 100px Arial';
        ctx.fillStyle = '#ff416c';
        ctx.fillText(title.toUpperCase(), canvas.width / 2, 850);
        
        // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
        ctx.font = '45px Arial';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        
        const lines = outcome.split('\n').filter(line => 
          line.trim() !== '' && 
          !line.includes('–¢–´ –°–¢–ê–õ:') && 
          !line.includes('–†–ï–î–ö–û–°–¢–¨:')
        );
        
        let yPos = 1050;
        for (let i = 0; i < Math.min(4, lines.length); i++) {
          ctx.fillText(lines[i], canvas.width / 2, yPos);
          yPos += 70;
        }
        
        // –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        ctx.font = 'bold 50px Arial';
        ctx.fillStyle = '#4CAF50';
        ctx.fillText('–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É!', canvas.width / 2, 1700);
        
        ctx.font = '40px Arial';
        ctx.fillStyle = '#4CAF50';
        ctx.fillText('vk.com/app' + APP_ID, canvas.width / 2, 1800);
        
        // –°–æ–∑–¥–∞–µ–º Data URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        resolve(dataUrl);
      });
    }

    // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –®–ï–†–ò–ù–ì–ê
    async function createAndShareStory() {
      if (isSharing) return;
      isSharing = true;
      
      updateStatus('üé® –°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–∏–Ω–∫—É...');
      
      try {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        const imageDataUrl = await createStoryImage();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ –º–æ–±–∏–ª—å–Ω–æ–º VK
        const mobileVK = isMobileVK();
        
        if (mobileVK && window.vkBridge) {
          // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ VK –ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–±
          updateStatus('üì± –ü—Ä–æ–±—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ...');
          
          // –í–ê–ñ–ù–û: VKWebAppShowStoryBox —Ç—Ä–µ–±—É–µ—Ç URL –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
          // –í –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          // –ù–æ –º—ã –º–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Data URL
          
          try {
            await window.vkBridge.send('VKWebAppInit', {});
            
            // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Data URL
            const result = await window.vkBridge.send('VKWebAppShowStoryBox', {
              background_type: 'image',
              url: imageDataUrl, // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–¥–∞—Ç—å Data URL
              attachment: {
                text: 'play',
                type: 'url',
                url: `https://vk.com/app${APP_ID}`
              }
            });
            
            if (result && result.result) {
              updateStatus('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∏—Å—Ç–æ—Ä–∏–∏ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ.');
              setTimeout(() => {
                showRandomStory();
                updateStatus('');
              }, 2000);
              return;
            }
          } catch (vkError) {
            console.log('VK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', vkError);
            updateStatus('‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤—ã—à–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–Ω–æ–π —Å–ø–æ—Å–æ–±');
          }
        }
        
        // –î–ª—è –ü–ö –∏–ª–∏ –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
        updateStatus('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∫–∞—Ä—Ç–∏–Ω–∫—É...');
        
        const title = getTitle(document.querySelector('.result').textContent);
        const filename = `–º–æ—è-—Å—É–¥—å–±–∞-${title.replace(/\s+/g, '-')}.jpg`;
        
        // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        downloadImage(imageDataUrl, filename);
        
        updateStatus('‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –î–æ–±–∞–≤—å –µ—ë –≤ –∏—Å—Ç–æ—Ä–∏–∏ VK –≤—Ä—É—á–Ω—É—é.');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å—Ç–∞
        const shareText = `üî• –Ø —Å—Ç–∞–ª: ${title}!\n\n–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ üëá\nhttps://vk.com/app${APP_ID}\n\n#–°—É–¥—å–±–∞–ó–∞10–°–µ–∫—É–Ω–¥ #VK–ú–∏–Ω–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`;
        
        setTimeout(() => {
          showManualInstructions(imageDataUrl, shareText, title);
        }, 1000);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        updateStatus('‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—á–Ω–æ–π —Å–ø–æ—Å–æ–± –∫–∞–∫ fallback
        try {
          const imageDataUrl = await createStoryImage();
          const title = getTitle(document.querySelector('.result').textContent);
          const shareText = `üî• –Ø —Å—Ç–∞–ª: ${title}!\n\n–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ üëá\nhttps://vk.com/app${APP_ID}\n\n#–°—É–¥—å–±–∞–ó–∞10–°–µ–∫—É–Ω–¥ #VK–ú–∏–Ω–∏–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`;
          
          showManualInstructions(imageDataUrl, shareText, title);
        } catch (e) {
          updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É');
        }
        
      } finally {
        isSharing = false;
      }
    }

    // –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ö–ê–†–¢–ò–ù–ö–ò
    function downloadImage(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (/mobile|android|iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase())) {
        setTimeout(() => {
          alert('‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –≥–∞–ª–µ—Ä–µ—é!\n\n–¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π VK ‚Üí –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é ‚Üí –î–æ–±–∞–≤—å —ç—Ç—É –∫–∞—Ä—Ç–∏–Ω–∫—É');
        }, 500);
      }
    }

    // –†–£–ß–ù–û–ô –°–ü–û–°–û–ë
    function showManualInstructions(imageDataUrl, shareText, title) {
      const outcome = document.querySelector('.result').textContent;
      
      document.getElementById('game').innerHTML = `
        <div class="result" id="resultBox">
          ${outcome}
          <div class="rarity">‚ö° –†–ï–î–ö–û–°–¢–¨: –õ–ï–ì–ï–ù–î–ê–†–ù–ê–Ø</div>
        </div>
        
        ${isMobileVK() ? `
          <div class="warning">
            <div class="warning-title">üì± –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≤—ã—à–ª–æ? –ù–µ –±–µ–¥–∞!</div>
            –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± ‚Äî –æ–Ω —Ç–æ–∂–µ —Å—É–ø–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π!
          </div>
        ` : `
          <div class="instructions">
            <div class="instructions-title">üé¨ –°–æ–∑–¥–∞–π —ç–ø–∏—á–µ—Å–∫—É—é –∏—Å—Ç–æ—Ä–∏—é!</div>
            –°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç—É –∫—Ä—É—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –æ–ø—É–±–ª–∏–∫—É–π –µ—ë –≤ —Å–≤–æ–∏—Ö –∏—Å—Ç–æ—Ä–∏—è—Ö VK!
          </div>
        `}
        
        <p><strong>–¢–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞:</strong></p>
        <img src="${imageDataUrl}" class="result-image" 
             onclick="downloadImage('${imageDataUrl.replace(/'/g, "\\'")}', '–º–æ—è-—Å—É–¥—å–±–∞-${title}.jpg')">
        
        <p style="margin: 15px 0;"><strong>–¢–µ–∫—Å—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏:</strong></p>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 10px 0; font-size: 14px;">
          ${shareText}
        </div>
        
        <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
          <p><em>üìù –ö–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å:</em></p>
          <p>1. –°–æ—Ö—Ä–∞–Ω–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É<br>2. –û—Ç–∫—Ä–æ–π VK<br>3. –ù–∞–∂–º–∏ ¬´–°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é¬ª<br>4. –î–æ–±–∞–≤—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –æ–ø—É–±–ª–∏–∫—É–π!</p>
        </div>
        
        <button class="btn btn-download" 
                onclick="downloadImage('${imageDataUrl.replace(/'/g, "\\'")}', '–º–æ—è-—Å—É–¥—å–±–∞-${title}.jpg')">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É
        </button>
        
        <button class="btn btn-copy" 
                onclick="copyToClipboard('${shareText.replace(/\n/g, '\\n').replace(/'/g, "\\'")}')">
          üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
        </button>
        
        ${isMobileVK() && window.vkBridge ? `
          <button class="btn btn-share" onclick="createAndShareStory()">
            üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–æ–≤–∞
          </button>
        ` : ''}
        
        <button class="btn btn-vip" onclick="showRandomStory()">
          üé≠ –£–∑–Ω–∞—Ç—å –¥—Ä—É–≥—É—é —Å—É–¥—å–±—É
        </button>
      `;
    }

    function copyToClipboard(text) {
      const unescapedText = text.replace(/\\n/g, '\n');
      navigator.clipboard.writeText(unescapedText)
        .then(() => {
          alert('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å –µ–≥–æ –≤ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é VK!');
        })
        .catch(err => {
          // –§–æ–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          const textArea = document.createElement('textarea');
          textArea.value = unescapedText;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          alert('‚úÖ –¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤—å –µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏—é VK!');
        });
    }

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    async function initApp() {
      updateStatus('üîÆ –ó–∞–≥—Ä—É–∂–∞—é –º–∞–≥–∏—é —Å—É–¥—å–±—ã...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      const inVK = isInVK();
      const mobileVK = isMobileVK();
      
      if (inVK) {
        updateStatus('‚úÖ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!');
        
        if (mobileVK) {
          updateStatus('üì± –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ VK');
        } else {
          updateStatus('üíª –í–µ–±-–≤–µ—Ä—Å–∏—è –∏–ª–∏ –ü–ö');
        }
        
        try {
          if (window.vkBridge) {
            await window.vkBridge.send('VKWebAppInit', {});
            updateStatus('‚ú® –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
            
            try {
              const userInfo = await window.vkBridge.send('VKWebAppGetUserInfo');
              userId = userInfo.id;
              updateStatus(`üé≠ –ü—Ä–∏–≤–µ—Ç, ${userInfo.first_name}!`);
            } catch (e) {
              updateStatus('üé≠ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø—É—Ç–Ω–∏–∫, —Ç–≤–æ—è —Å—É–¥—å–±–∞ –∂–¥—ë—Ç!');
            }
          }
        } catch (error) {
          console.log('VK Bridge:', error.message);
          updateStatus('‚ú® –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ! –í—ã–±–∏—Ä–∞–π –∏—Å—Ç–æ—Ä–∏—é!');
        }
      } else {
        updateStatus('üéÆ –î–µ–º–æ-—Ä–µ–∂–∏–º | –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –≤ VK!');
      }
      
      showRandomStory();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
