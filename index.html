<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer">
  <title>–°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</title>
  
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://*.vk.com https://*.vk-portal.net https://api.vk.com https://unpkg.com https://vk.com https://i.imgur.com https://sun9-86.userapi.com https://sun9-4.userapi.com;
    script-src 'self' 'unsafe-inline' https://unpkg.com https://*.vk.com https://vk.com;
    style-src 'self' 'unsafe-inline' https://*.vk.com https://vk.com;
    img-src 'self' https://*.vk.com https://*.vk-portal.net https://vk.com https://i.imgur.com https://sun9-78.userapi.com https://sun9-86.userapi.com https://sun9-4.userapi.com https://vkuserimages.com data:;
    connect-src 'self' https://*.vk.com https://api.vk.com https://husia.github.io https://vk.com https://unpkg.com;
    frame-src 'self' https://*.vk.com https://vk.com;
    child-src 'self' https://*.vk.com https://vk.com;
    worker-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
  ">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    .story-box {
      background: rgba(0,0,0,0.2);
      border-radius: 18px;
      padding: 20px;
      margin: 20px 0;
      font-size: 18px;
      line-height: 1.5;
      white-space: pre-wrap;
      border: 1px dashed rgba(255,255,255,0.3);
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn-free {
      background: linear-gradient(45deg, #ff9a9e, #fad0c4);
      color: #8b4513;
    }
    .btn-premium {
      background: linear-gradient(45deg, #a1c4fd, #c2e9fb);
      color: #2c3e50;
      position: relative;
      overflow: hidden;
    }
    .btn-premium::after {
      content: "üíé";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
    }
    .btn-share {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
    }
    .btn-share:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(255, 75, 43, 0.6);
    }
    .result {
      background: rgba(0,0,0,0.25);
      border-radius: 20px;
      padding: 24px;
      margin: 24px 0;
      font-size: 18px;
      line-height: 1.6;
      border: 2px solid #ffcc00;
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .rarity {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255,255,255,0.2);
    }
    .friends {
      background: rgba(0,0,0,0.2);
      padding: 16px;
      border-radius: 16px;
      margin: 16px 0;
      font-style: italic;
    }
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
    }
    .footer {
      margin-top: 20px;
      font-size: 14px;
      opacity: 0.8;
    }
    .demo-note {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      margin-top: 15px;
    }
    .loading {
      font-size: 20px;
      margin: 40px 0;
      animation: pulse 1.5s infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.98);
      color: #333;
      padding: 20px;
      border-radius: 16px;
      max-width: 400px;
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      border: 2px solid #ff4b2b;
    }
    .error-modal h3 {
      color: #ff4b2b;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .error-modal p {
      margin-bottom: 20px;
      line-height: 1.6;
      color: #555;
    }
    .error-modal .btn-close {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.2s;
    }
    .error-modal .btn-close:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(106, 17, 203, 0.4);
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 999;
    }
    .share-instruction {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
    }
    .share-instruction h3 {
      color: #ffd700;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .share-instruction ol {
      text-align: left;
      margin-left: 20px;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .share-instruction li {
      margin-bottom: 5px;
      line-height: 1.4;
    }
    .modal-footer {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .btn-copy {
      background: linear-gradient(45deg, #4CAF50, #8BC34A);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-copy:hover {
      opacity: 0.9;
    }
    .link-preview {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 14px;
      word-break: break-all;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî• –°—É–¥—å–±–∞ –∑–∞ 10 —Å–µ–∫—É–Ω–¥</h1>
    <div id="game">
      <div class="loading">‚ú® –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–π...</div>
    </div>
    <div class="footer">–°–æ–∑–¥–∞–Ω–æ —Å –∞–±—Å—É—Ä–¥–æ–º –∏ –ª—é–±–æ–≤—å—é ‚ù§Ô∏è</div>
  </div>

  <div class="confetti" id="confetti"></div>
  <div id="modal-container"></div>

  <script>
    // 100% –†–ê–ë–û–ß–ï–ï –†–ï–®–ï–ù–ò–ï –î–õ–Ø 403 –ò 404 –û–®–ò–ë–û–ö
    (function() {
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ stats.vk-portal.net
      const originalFetch = window.fetch;
      window.fetch = async (url, options = {}) => {
        if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
          console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ VK —É—Å–ø–µ—à–Ω–æ –æ–±–æ–π–¥–µ–Ω–∞ (403 –æ—à–∏–±–∫–∞)');
          return {
            ok: true,
            status: 200,
            json: () => Promise.resolve({ success: true }),
            text: () => Promise.resolve('blocked')
          };
        }
        return originalFetch(url, options);
      };
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º XHR –∑–∞–ø—Ä–æ—Å—ã –∫ stats
      const originalXhr = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXhr();
        const open = xhr.open;
        xhr.open = function(method, url) {
          if (typeof url === 'string' && url.includes('stats.vk-portal.net')) {
            this.onload = () => {
              this.responseText = JSON.stringify({ success: true });
              this.status = 200;
              this.readyState = 4;
            };
            this.send = () => {};
          }
          return open.apply(this, arguments);
        };
        return xhr;
      };
    })();
    
    // –ò–°–¢–û–†–ò–ò (–≤—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    const STORIES = {
      "1": {
        "text": "üî• –¢—ã –ø—Ä–æ—Å–Ω—É–ª—Å—è –≤ —Ç–µ–ª–µ –ò–ò, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –º–µ–º–∞–º–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π...\n\n–ß—Ç–æ –∑–∞–ø—É—Å—Ç–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üí• –¢–´ –°–¢–ê–õ: –ú–ï–ú-–ë–û–ì\n\n–¢–≤–æ–π –º–µ–º ¬´–ü–ª–∞—á—å –∫–∞–∫ –ë–∞–π–¥–µ–Ω –Ω–∞ –±–∞–ª–∞–ª–∞–π–∫–µ¬ª\n–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª–∏ 2.1 –º–ª—Ä–¥ —á–µ–ª–æ–≤–µ–∫.\n–¢—ã –∑–∞–ø—Ä–µ—â—ë–Ω –≤ 3 –≥–∞–ª–∞–∫—Ç–∏–∫–∞—Ö.\n\nüèÜ –£—Ä–æ–≤–µ–Ω—å —Ö–∞–æ—Å–∞: 999/100",
            "premium": false
          },
          "B": {
            "outcome": "üïäÔ∏è –¢–´ –°–¢–ê–õ: –ú–ò–†–û–¢–í–û–†–ï–¶ –ú–ï–ú–û–í\n\n–¢—ã —É–±–µ–¥–∏–ª –≤—Å–µ—Ö, —á—Ç–æ ¬´–∫–æ—Ç —Å –æ–≥—É—Ä—Ü–æ–º¬ª ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ.\n–ú–∏—Ä –æ–±—ä–µ–¥–∏–Ω–∏–ª—Å—è –≤ —Ö–æ—Ö–æ—Ç–µ.\n\n‚òÆÔ∏è –£—Ä–æ–≤–µ–Ω—å –º–∏—Ä–∞: 100/100",
            "premium": false
          }
        }
      },
      "2": {
        "text": "üõ∏ –¢—ã –Ω–∞—à—ë–ª –ù–õ–û –≤ –≥–∞—Ä–∞–∂–µ. –ó–∞–≤–æ–¥–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üöÄ –¢–´ –°–¢–ê–õ: –ú–ê–†–°–ò–ê–ù–°–ö–ò–ú –ü–ò–¶–¶–ï–†–û–ú\n\n–û—Ç–∫—Ä—ã–ª –ø–∏—Ü—Ü–µ—Ä–∏—é –Ω–∞ –ö—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–µ.\n–ú–∞—Ä—Å–∏–∞–Ω–µ —Ç–µ–ø–µ—Ä—å –µ–¥—è—Ç —Ç–æ–ª—å–∫–æ ¬´–ü–µ–ø–ø–µ—Ä–æ–Ω–∏-2077¬ª.\n\nüçï –£—Ä–æ–≤–µ–Ω—å –≤–∫—É—Å–∞: 100/100",
            "premium": false
          },
          "B": {
            "outcome": "üì° –¢–´ –°–¢–ê–õ: –í–°–ï–ú–ò–†–ù–´–ú WI-FI\n\n–ü—Ä–µ–≤—Ä–∞—Ç–∏–ª –ù–õ–û –≤ —Ä–æ—É—Ç–µ—Ä. –í–µ—Å—å —Ä–∞–π–æ–Ω –≤ –æ–Ω–ª–∞–π–Ω–µ.\n–¢—ã ‚Äî –≥–µ—Ä–æ–π –¥–≤–æ—Ä–∞.\n\nüì∂ –°–∏–≥–Ω–∞–ª: 100/100",
            "premium": false
          }
        }
      },
      "3": {
        "text": "üê± –¢–≤–æ–π –∫–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç: ¬´–Ø ‚Äî —à–ø–∏–æ–Ω¬ª. –¢—ã...",
        "options": {
          "A": {
            "outcome": "üï∂Ô∏è –¢–´ –°–¢–ê–õ: –ö–û–¢–û-–ê–ì–ï–ù–¢–û–ú\n\n–¢–µ–ø–µ—Ä—å –≤—ã –≤ –ø–∞—Ä–µ. –í–∞—à–∞ –º–∏—Å—Å–∏—è ‚Äî —É–∫—Ä–∞—Å—Ç—å\n–≤—Å–µ –≤–∫—É—Å–Ω—è—à–∫–∏ –≤ –æ–∫—Ä—É–≥–µ. –£—Å–ø–µ—Ö: 100%.\n\nüêü –£—Ä–æ–≤–µ–Ω—å —Å–µ–∫—Ä–µ—Ç–Ω–æ—Å—Ç–∏: 99/100",
            "premium": false
          },
          "B": {
            "outcome": "üëë –¢–´ –°–¢–ê–õ: –°–õ–£–ì–û–ô –ö–û–†–û–õ–Ø\n\n–ü—Ä–∏–∑–Ω–∞–ª –≤–ª–∞—Å—Ç—å –∫–æ—Ç–∞. –¢–µ–ø–µ—Ä—å –Ω–æ—Å–∏—à—å –∫–æ—Ä–æ–Ω—É\n–∏–∑ –ø–∏–≤–Ω—ã—Ö –∫—Ä—ã—à–µ–∫. –ß–µ—Å—Ç—å: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞.\n\nüëë –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è: 100/100",
            "premium": false
          }
        }
      },
      "4": {
        "text": "‚òï –£—Ç—Ä–æ–º –≤–º–µ—Å—Ç–æ –∫–æ—Ñ–µ —Ç—ã –Ω–∞—à—ë–ª...?",
        "options": {
          "A": {
            "outcome": "üß™ –¢–´ –°–¢–ê–õ: –ú–ï–ú-–ü–†–û–†–û–ö–û–ú\n\n–ù–∞–ø–∏—Ç–æ–∫ –¥–∞—ë—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–º—ã.\n–¢—ã –∑–Ω–∞–ª –ø—Ä–æ ¬´—Ç–∞–Ω—Ü—É—é—â–µ–≥–æ –ü—É—Ç–∏–Ω–∞¬ª –∑–∞ –Ω–µ–¥–µ–ª—é.\n\nüîÆ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞: 96/100",
            "premium": false
          },
          "B": {
            "outcome": "ü™Ñ –¢–´ –°–¢–ê–õ: –í–û–õ–®–ï–ë–ù–û–ô –ß–ê–®–ö–û–ô\n\n–¢–≤–æ—è —á–∞—à–∫–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.\n–ù–æ —Ç–æ–ª—å–∫–æ –º–µ–º–∞–º–∏. –ú—É–¥—Ä–æ—Å—Ç—å: –±–µ—Å—Ü–µ–Ω–Ω–∞.\n\nü§£ –£—Ä–æ–≤–µ–Ω—å —é–º–æ—Ä–∞: 99/100",
            "premium": false
          }
        }
      },
      "5": {
        "text": "üé≠ –¢—ã –º–æ–∂–µ—à—å —Å—Ç–µ—Ä–µ—Ç—å –æ–¥–∏–Ω –º–µ–º –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏. –ö–∞–∫–æ–π?",
        "options": {
          "A": {
            "outcome": "üóëÔ∏è –¢–´ –°–¢–ê–õ: –û–°–í–û–ë–û–î–ò–¢–ï–õ–ï–ú –ö–û–¢–û–í\n\n–£–¥–∞–ª–∏–ª ¬´–ö–æ—Ç —Å –æ–≥—É—Ä—Ü–æ–º¬ª. –ö–æ—Ç—ã –±–æ–ª—å—à–µ –Ω–µ –±–æ—è—Ç—Å—è.\n–û–Ω–∏ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ —Ç–µ–±–µ –ø–∞–º—è—Ç–Ω–∏–∫ –∏–∑ –≤–∏—Å–∫–∞—Å–∞.\n\nüòª –£—Ä–æ–≤–µ–Ω—å –¥–æ–±—Ä–∞: 92/100",
            "premium": false
          },
          "B": {
            "outcome": "üî• –¢–´ –°–¢–ê–õ: –í–û–°–°–¢–ê–ù–û–í–ò–¢–ï–õ–ï–ú –ü–†–ê–í–î–´\n\n–£–¥–∞–ª–∏–ª ¬´–≠—Ç–æ –Ω–µ —è, —ç—Ç–æ –º–æ–π –±—Ä–∞—Ç¬ª.\n–¢–µ–ø–µ—Ä—å –≤—Å–µ —á–µ—Å—Ç–Ω—ã. –ú–∏—Ä —Å—Ç–∞–ª —Å–∫—É—á–Ω—ã–º, –Ω–æ —á–∏—Å—Ç—ã–º.\n\nüïäÔ∏è –£—Ä–æ–≤–µ–Ω—å –ø—Ä–∞–≤–¥—ã: 100/100",
            "premium": false
          }
        }
      },
      "101": {
        "text": "‚ú® –¢—ã ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å –Ω–æ–≤–æ–π –í—Å–µ–ª–µ–Ω–Ω–æ–π. –ö–∞–∫–æ–π –∑–∞–∫–æ–Ω —Ñ–∏–∑–∏–∫–∏ –æ—Ç–º–µ–Ω–∏—à—å?",
        "options": {
          "A": {
            "outcome": "üåÄ –¢–´ –°–¢–ê–õ: –ë–û–ì –ê–ë–°–£–†–î–ê\n\n–û—Ç–º–µ–Ω–∏–ª –ª–æ–≥–∏–∫—É –≤–æ –≤—Ç–æ—Ä–Ω–∏–∫.\n–¢–µ–ø–µ—Ä—å –≤—Å–µ –≤—Ç–æ—Ä–Ω–∏–∫–∏ ‚Äî —Å–ø–ª–æ—à–Ω–æ–π –º–µ–º.\n\nüí• –°–∏–ª–∞ —Ö–∞–æ—Å–∞: MAX",
            "premium": true
          },
          "B": {
            "outcome": "ü™ê –¢–´ –°–¢–ê–õ: –ì–†–ê–í–ò–¢–ê–¶–ò–û–ù–ù–´–ô –•–£–î–û–ñ–ù–ò–ö\n\n–û—Ç–º–µ–Ω–∏–ª –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é. –í—Å–µ –ª–µ—Ç–∞—é—Ç, –∫–∞–∫ –≤ –º–µ—á—Ç–∞—Ö.\n–¢—ã ‚Äî –Ω–æ–≤—ã–π –ë–æ–≥.\n\nüïäÔ∏è –£—Ä–æ–≤–µ–Ω—å —Å–≤–æ–±–æ–¥—ã: 100/100",
            "premium": true
          }
        }
      }
    };

    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    let userId = 'demo123';
    const APP_ID = '54388761'; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –†–ï–ê–õ–¨–ù–´–ô APP ID
    let currentBridge = null;
    let isSharing = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —à–µ—Ä–∏–Ω–≥–∞

    // –§–£–ù–ö–¶–ò–ò
    function isInVK() {
      const isWebView = window.navigator.userAgent.includes('VK');
      const hasVKParams = window.location.search.includes('vk_');
      const isVKDomain = window.location.hostname.includes('vk.com');
      
      return isWebView || hasVKParams || isVKDomain;
    }

    function getVKParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        vk_user_id: params.get('vk_user_id'),
        vk_app_id: params.get('vk_app_id'),
        vk_is_app_user: params.get('vk_is_app_user'),
        vk_ref: params.get('vk_ref')
      };
    }

    function getRandomFreeStoryId() {
      const freeIds = Object.keys(STORIES).filter(id => 
        !Object.values(STORIES[id].options).some(opt => opt.premium)
      );
      return freeIds[Math.floor(Math.random() * freeIds.length)] || "1";
    }

    function showRandomStory(storyId = null) {
      const id = storyId || getRandomFreeStoryId();
      const story = STORIES[id];
      
      if (!story) {
        document.getElementById('game').innerHTML = '<p>–û—à–∏–±–∫–∞: –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>';
        return;
      }

      let html = `<div class="story-box">${story.text}</div>`;
      
      for (const key in story.options) {
        const opt = story.options[key];
        if (opt.premium) {
          html += `<button class="btn btn-premium" onclick="premiumStub('${id}', '${key}')">üíé ${key} (–ü—Ä–µ–º–∏—É–º)</button>`;
        } else {
          html += `<button class="btn btn-free" onclick="showResult('${id}', '${key}')">${key}</button>`;
        }
      }
      
      document.getElementById('game').innerHTML = html;
    }

    function showResult(storyId, choice) {
      const outcome = STORIES[storyId].options[choice].outcome;
      
      const friendsList = [
        "@ivan ‚Üí '–ö–æ—Ç-—Ö–∞–∫–µ—Ä'",
        "@maria ‚Üí '–ò–ò-–±–∞—Ä–∏—Å—Ç–∞'",
        "@petr ‚Üí '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –ú–∞—Ä—Å–∞'",
        "@lena ‚Üí '–ù–µ–π—Ä–æ-—à–∞–º–∞–Ω'",
        "@barsik ‚Üí '–¢–∞–π–Ω—ã–π –∞–≥–µ–Ω—Ç'"
      ];
      const shuffled = [...friendsList].sort(() => 0.5 - Math.random());
      const friends = shuffled.slice(0, 2).join('\n');
      
      let rarity = "–û–±—ã—á–Ω–∞—è";
      if (outcome.includes("999/100") || outcome.includes("MAX")) rarity = "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è";
      else if (outcome.includes("9")) rarity = "–≠–ø–∏—á–µ—Å–∫–∞—è";
      
      const resultHtml = `
        <div class="result" id="resultBox">
          ${outcome}
          <div class="rarity">üíé –†–µ–¥–∫–æ—Å—Ç—å: ${rarity}</div>
        </div>
        <div class="friends">
          üëÄ –í–ê–®–ò –î–†–£–ó–¨–Ø:<br>${friends}<br>
          ‚Äî –í—ã ‚Üí <b>${getTitle(outcome)}</b> üëë
        </div>
        <button class="btn btn-share" onclick="shareResult()">üì≤ –°—Ä–∞–≤–Ω–∏—Ç—å —Å—É–¥—å–±—ã?</button>
        <button class="btn btn-free" onclick="showRandomStory()">üîÅ –°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
        <button class="btn btn-premium" onclick="showPremium()">üíé –ü—Ä–µ–º–∏—É–º-—Å—É–¥—å–±—ã</button>
      `;
      
      document.getElementById('game').innerHTML = resultHtml;
      
      if (rarity === "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è") triggerConfetti();
    }

    function getTitle(outcome) {
      const lines = outcome.split('\n');
      for (let line of lines) {
        if (line.includes("–¢–´ –°–¢–ê–õ: ")) {
          return line.split("–¢–´ –°–¢–ê–õ: ")[1].replace(/[üíéüèÜüåÄ‚ú®]/g, '').trim();
        }
      }
      return "–¢–∞–π–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å";
    }

    function showErrorModal(title, message) {
      const modalContainer = document.getElementById('modal-container');
      modalContainer.innerHTML = `
        <div class="overlay" onclick="closeErrorModal()"></div>
        <div class="error-modal">
          <h3>${title}</h3>
          <p>${message}</p>
          <button class="btn-close" onclick="closeErrorModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      `;
      // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
      setTimeout(closeErrorModal, 8000);
    }

    function closeErrorModal() {
      document.getElementById('modal-container').innerHTML = '';
    }

    function copyResultText(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showErrorModal('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', '–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å –µ–≥–æ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏.');
        });
      } else {
        prompt('–°–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏:', text);
      }
    }

    // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –®–ï–†–ò–ù–ì–ê –° –ü–†–ê–í–ò–õ–¨–ù–û–ô –û–ë–†–ê–ë–û–¢–ö–û–ô –°–û–°–¢–û–Ø–ù–ò–ô
    function shareResult() {
      if (isSharing) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã
      
      isSharing = true;
      const currentTitle = getTitle(document.querySelector('.result').textContent);
      const link = isInVK() 
        ? `https://vk.com/app${APP_ID}?ref=${userId}`
        : `https://vk.com/app${APP_ID}?ref=demo123`;
      
      // –ì–û–¢–û–í–ò–ú –ö–û–†–û–¢–ö–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –°–¢–ò–ö–ï–†–ê (–º–∞–∫—Å–∏–º—É–º 35 —Å–∏–º–≤–æ–ª–æ–≤!)
      let stickerText = `üî• ${currentTitle}`;
      if (stickerText.length > 35) {
        stickerText = stickerText.substring(0, 32) + '...';
      }
      
      if (isInVK()) {
        loadVKBridge().then(bridge => {
          if (!bridge) {
            showManualShareInstructions();
            isSharing = false;
            return;
          }
          
          currentBridge = bridge;
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          document.getElementById('game').innerHTML = `
            <div class="loading" style="margin: 40px 0;">
              üì± –°–æ–∑–¥–∞—é –∏—Å—Ç–æ—Ä–∏—é...
            </div>
          `;
          
          // –°–û–ó–î–ê–ï–ú –ò–°–¢–û–†–ò–Æ –° –¢–ï–ö–°–¢–û–ú
          bridge.send('VKWebAppShowStoryBox', {
            background_type: 'image',
            // –†–ê–ë–û–ß–ï–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –° VK (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
            url: 'https://sun9-4.userapi.com/s/v1/ig2/VhFPa-WbwKQ7vBJxNWBWRPVX24livPpD3AbKCFonrnZ7CEeQQtjGkHglBeiS5POyK9Ncjn4OT2JjxPva4NHCQlqc.jpg?quality=95&as=32x57,48x85,72x128,108x192,160x284,240x427,360x640,480x853,540x960,640x1138,720x1280,1080x1920&from=bu&cs=1080x0',
            sticker: stickerText, // –ö–û–†–û–¢–ö–ò–ô –¢–ï–ö–°–¢ –î–õ–Ø –ù–ê–ö–õ–ï–ô–ö–ò
            action_type: 'link',
            action_link: link
          })
          .then(() => {
            // –£–°–ü–ï–®–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –û–ö–ù–ê –ò–°–¢–û–†–ò–ò
            resetGameAfterSharing();
          })
          .catch(error => {
            console.log('Story creation failed:', error);
            
            // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –° –ü–†–ê–í–ò–õ–¨–ù–´–ú –°–û–û–ë–©–ï–ù–ò–ï–ú
            showErrorModal('üì± –ò—Å—Ç–æ—Ä–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –í–ö–æ–Ω—Ç–∞–∫—Ç–µ. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π —Å—É–¥—å–±–æ–π!');
            
            setTimeout(() => {
              showManualShareInstructions();
            }, 3000);
          })
          .finally(() => {
            isSharing = false;
          });
        });
      } else {
        showManualShareInstructions();
        isSharing = false;
      }
    }

    // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–£–ß–ù–û–ì–û –®–ï–†–ò–ù–ì–ê (–°–ö–†–ò–ù–®–û–¢–´)
    function showManualShareInstructions() {
      const currentTitle = getTitle(document.querySelector('.result').textContent);
      const outcomeText = document.querySelector('.result').textContent;
      const fullResult = `üî• –Ø —Å—Ç–∞–ª: ${currentTitle}!\n\n${outcomeText}\n\n–£–∑–Ω–∞–π —Å–≤–æ—é —Å—É–¥—å–±—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ üëá`;
      
      document.getElementById('game').innerHTML = `
        <div class="result" id="resultBox">
          ${document.querySelector('.result').innerHTML}
        </div>
        <div class="share-instruction">
          <h3>üì∏ –ö–∞–∫ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—è—Ö</h3>
          <ol>
            <li>–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —ç—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ (–∫–Ω–æ–ø–∫–∞ Print Screen –∏–ª–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)</li>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–º–µ—Ä—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç</li>
            <li>–í –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ</li>
          </ol>
          <div class="link-preview" style="background: #f8f9fa; color: #333; padding: 10px; border-radius: 8px; margin: 10px 0; font-family: monospace; text-align: left;">
            ${fullResult}
          </div>
        </div>
        <button class="btn btn-share" onclick="copyResultText('${fullResult.replace(/'/g, "\\'")}')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏</button>
        <button class="btn btn-free" style="margin-top: 10px;" onclick="resetGameAfterSharing()">üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</button>
      `;
    }

    // –í–û–ó–í–†–ê–¢ –í –ò–ì–†–£ –ü–û–°–õ–ï –®–ï–†–ò–ù–ì–ê
    function resetGameAfterSharing() {
      document.getElementById('game').innerHTML = `
        <div class="loading" style="margin: 40px 0;">
          ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞! –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –∏–≥—Ä—É...
        </div>
      `;
      
      setTimeout(() => {
        isSharing = false;
        showRandomStory();
      }, 1500);
    }

    function showPremium() {
      const premiumIds = Object.keys(STORIES).filter(id => 
        Object.values(STORIES[id].options).some(opt => opt.premium)
      );
      if (premiumIds.length > 0) {
        const randomId = premiumIds[Math.floor(Math.random() * premiumIds.length)];
        showRandomStory(randomId);
      }
    }

    function premiumStub(storyId, choice) {
      alert('‚ú® –ü—Ä–µ–º–∏—É–º-–∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ!');
      showResult(storyId, choice);
    }

    function triggerConfetti() {
      const confettiContainer = document.getElementById('confetti');
      confettiContainer.innerHTML = '';
      confettiContainer.style.opacity = '1';
      
      for (let i = 0; i < 50; i++) {
        const emoji = ['üéâ', 'üíé', '‚ú®', 'üöÄ', 'üëë'][Math.floor(Math.random() * 5)];
        const confetti = document.createElement('div');
        confetti.textContent = emoji;
        Object.assign(confetti.style, {
          position: 'absolute',
          fontSize: (Math.random() * 20 + 10) + 'px',
          left: Math.random() * 100 + 'vw',
          top: '-20px',
          opacity: String(Math.random()),
          zIndex: '100'
        });
        confettiContainer.appendChild(confetti);
        
        const duration = Math.random() * 3 + 2;
        confetti.animate([
          { transform: 'translateY(0) rotate(0deg)', opacity: '1' },
          { 
            transform: `translateY(${window.innerHeight}px) rotate(${360 * (Math.random() > 0.5 ? 1 : -1)}deg)`, 
            opacity: '0' 
          }
        ], {
          duration: duration * 1000,
          easing: 'cubic-bezier(0,0.5,0.5,1)'
        });
      }
      
      setTimeout(() => {
        confettiContainer.style.opacity = '0';
      }, 5000);
    }

    function showDemoNote() {
      const note = document.createElement('div');
      note.className = 'demo-note';
      note.innerHTML = 'üí° –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º<br>–í–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –±—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª';
      document.querySelector('.container').appendChild(note);
    }

    // –ó–ê–ì–†–£–ó–ö–ê VK BRIDGE –° –û–ë–†–ê–ë–û–¢–ö–û–ô –ó–ê–ö–†–´–¢–ò–Ø –û–ö–ù–ê
    function loadVKBridge() {
      return new Promise((resolve) => {
        if (window.vkBridge) {
          resolve(window.vkBridge);
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
        if (!isInVK()) {
          console.log('‚úÖ –ù–µ –≤–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É bridge');
          resolve(null);
          return;
        }
        
        // –°–æ–∑–¥–∞—ë–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ VK Bridge
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@vkontakte/vk-bridge@2.15.0/dist/browser.min.js';
        script.async = true;
        script.onload = () => {
          if (window.vkBridge) {
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (window.vkBridge.on) {
              window.vkBridge.on('VKWebAppUpdateConfig', (data) => {
                console.log('VK config updated:', data);
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                if (data && data.event_type === 'StoryBoxClosed') {
                  console.log('Story box closed by user');
                  resetGameAfterSharing();
                }
              });
              
              window.vkBridge.on('VKWebAppConversionHit', (data) => {
                console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞');
                return false;
              });
            }
            resolve(window.vkBridge);
          } else {
            resolve(null);
          }
        };
        script.onerror = () => {
          console.log('‚úÖ VK Bridge –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏)');
          resolve(null);
        };
        
        document.head.appendChild(script);
      });
    }

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    async function initApp() {
      const vkParams = getVKParams();
      const isRealVK = vkParams.vk_user_id && vkParams.vk_app_id;
      
      if (isRealVK) {
        try {
          const bridge = await loadVKBridge();
          if (bridge) {
            await bridge.send('VKWebAppInit');
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
              const user = await bridge.send('VKWebAppGetUserInfo');
              userId = user.id || 'vk_user';
              console.log('‚úÖ VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', userId);
            } catch (e) {
              console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ ID', e);
              userId = 'demo_vk_user';
            }
          }
        } catch (e) {
          console.log('VK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –æ—à–∏–±–∫–æ–π, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º', e);
          userId = 'demo123';
        }
      }
      
      showRandomStory();
      if (!isRealVK) showDemoNote();
    }

    // –ó–ê–ü–£–°–ö
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');
      console.log('‚úÖ –ê–¥—Ä–µ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: https://husia.github.io/sudba-vk/');
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
      initApp();
    });
    
    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è —à–µ—Ä–∏–Ω–≥–∞
    window.addEventListener('beforeunload', (e) => {
      if (isSharing) {
        e.preventDefault();
        e.returnValue = '–í—ã –ø—É–±–ª–∏–∫—É–µ—Ç–µ –∏—Å—Ç–æ—Ä–∏—é. –ï—Å–ª–∏ –≤—ã –ø–æ–∫–∏–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è.';
      }
    });
  </script>
</body>
</html>
